@model HeatExchangeApp.Models.CalculationModel
@{
    ViewData["Title"] = "Калькулятор теплообмена";
    var results = ViewBag.Results as List<HeatExchangeApp.Models.CalculationResult>;
    var savedId = ViewBag.SavedId as int?;
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-input-cursor-text"></i> Ввод параметров</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="calculationForm">
                        <input type="hidden" asp-for="CalculationName" />

                        <div class="mb-3">
                            <label asp-for="CalculationName" class="form-label">Название расчета</label>
                            <input asp-for="CalculationName" class="form-control" />
                            <span asp-validation-for="CalculationName" class="text-danger"></span>
                        </div>

                        <h6 class="border-bottom pb-2">Основные параметры</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Height" class="form-label">@Html.DisplayNameFor(m => m.Height)</label>
                                <input asp-for="Height" class="form-control" />
                                <span asp-validation-for="Height" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="ApparatusDiameter" class="form-label">@Html.DisplayNameFor(m => m.ApparatusDiameter)</label>
                                <input asp-for="ApparatusDiameter" class="form-control" />
                                <span asp-validation-for="ApparatusDiameter" class="text-danger"></span>
                            </div>
                        </div>

                        <h6 class="border-bottom pb-2">Температуры</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="MaterialInitialTemp" class="form-label">@Html.DisplayNameFor(m => m.MaterialInitialTemp)</label>
                                <input asp-for="MaterialInitialTemp" class="form-control" />
                                <span asp-validation-for="MaterialInitialTemp" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="GasInitialTemp" class="form-label">@Html.DisplayNameFor(m => m.GasInitialTemp)</label>
                                <input asp-for="GasInitialTemp" class="form-control" />
                                <span asp-validation-for="GasInitialTemp" class="text-danger"></span>
                            </div>
                        </div>

                        <h6 class="border-bottom pb-2">Параметры газа</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="GasVelocity" class="form-label">@Html.DisplayNameFor(m => m.GasVelocity)</label>
                                <input asp-for="GasVelocity" class="form-control" />
                                <span asp-validation-for="GasVelocity" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="GasHeatCapacity" class="form-label">@Html.DisplayNameFor(m => m.GasHeatCapacity)</label>
                                <input asp-for="GasHeatCapacity" class="form-control" />
                                <span asp-validation-for="GasHeatCapacity" class="text-danger"></span>
                            </div>
                        </div>

                        <h6 class="border-bottom pb-2">Параметры материала</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="MaterialFlowRate" class="form-label">@Html.DisplayNameFor(m => m.MaterialFlowRate)</label>
                                <input asp-for="MaterialFlowRate" class="form-control" />
                                <span asp-validation-for="MaterialFlowRate" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="MaterialHeatCapacity" class="form-label">@Html.DisplayNameFor(m => m.MaterialHeatCapacity)</label>
                                <input asp-for="MaterialHeatCapacity" class="form-control" />
                                <span asp-validation-for="MaterialHeatCapacity" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="HeatTransferCoefficient" class="form-label">@Html.DisplayNameFor(m => m.HeatTransferCoefficient)</label>
                            <input asp-for="HeatTransferCoefficient" class="form-control" />
                            <span asp-validation-for="HeatTransferCoefficient" class="text-danger"></span>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="submit" formaction="@Url.Action("ShowResults", "Home")"
                                    class="btn btn-outline-primary me-md-2">
                                <i class="bi bi-calculator"></i> Рассчитать
                            </button>
                            <button type="submit" formaction="@Url.Action("Calculate", "Home")"
                                    class="btn btn-success">
                                <i class="bi bi-save"></i> Сохранить расчет
                            </button>
                        </div>
                    </form>

                    @if (savedId.HasValue)
                    {
                        <div class="alert alert-success mt-3">
                            <i class="bi bi-check-circle"></i> Расчет сохранен под ID: @savedId.Value
                        </div>
                    }
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="bi bi-info-circle"></i> Справка</h6>
                </div>
                <div class="card-body">
                    <p>
                        <small>
                            <strong>Формулы расчета:</strong><br>
                            1. Отношение теплоемкостей: m = (G<sub>м</sub>·C<sub>м</sub>) / (V<sub>г</sub>·C<sub>г</sub>)<br>
                            2. Безразмерная высота: Y = (α<sub>V</sub>·y) / (w<sub>г</sub>·C<sub>г</sub>)<br>
                            3. Температуры рассчитываются по аналитическому решению для противотока
                        </small>
                    </p>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            @if (results != null && results.Any())
            {
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-table"></i> Результаты расчета</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-striped">
                                <thead class="table-light">
                                    <tr>
                                        <th>Высота, м</th>
                                        <th>Т мат, °C</th>
                                        <th>Т газа, °C</th>
                                        <th>ΔT, °C</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in results)
                                    {
                                        <tr>
                                            <td>@item.Height</td>
                                            <td>@item.MaterialTemperature</td>
                                            <td>@item.GasTemperature</td>
                                            <td class="@(item.TemperatureDifference > 0 ? "text-success" : "text-danger")">
                                                <strong>@item.TemperatureDifference</strong>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Графики температур</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="temperatureChart"></canvas>
                        </div>
                        <div class="chart-container mt-3">
                            <canvas id="differenceChart"></canvas>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-graph-up" style="font-size: 3rem; color: #ccc;"></i>
                        <h5 class="mt-3 text-muted">Результаты расчета</h5>
                        <p class="text-muted">Введите параметры и нажмите "Рассчитать"</p>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    @if (results != null && results.Any())
    {
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // Подготовка данных для графиков
                const heights = @Html.Raw(Json.Serialize(results.Select(r => r.Height)));
                const materialTemps = @Html.Raw(Json.Serialize(results.Select(r => r.MaterialTemperature)));
                const gasTemps = @Html.Raw(Json.Serialize(results.Select(r => r.GasTemperature)));
                const differences = @Html.Raw(Json.Serialize(results.Select(r => r.TemperatureDifference)));

                // График температур материала и газа
                const tempCtx = document.getElementById('temperatureChart').getContext('2d');
                new Chart(tempCtx, {
                    type: 'line',
                    data: {
                        labels: heights,
                        datasets: [
                            {
                                label: 'Температура материала, °C',
                                data: materialTemps,
                                borderColor: 'rgb(255, 99, 132)',
                                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                borderWidth: 2,
                                tension: 0.3
                            },
                            {
                                label: 'Температура газа, °C',
                                data: gasTemps,
                                borderColor: 'rgb(54, 162, 235)',
                                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                                borderWidth: 2,
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Изменение температур по высоте слоя'
                            }
                        },
                        scales: {
                            y: {
                                title: {
                                    display: true,
                                    text: 'Температура, °C'
                                },
                                beginAtZero: false
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Высота, м'
                                }
                            }
                        }
                    }
                });

                // График разности температур
                const diffCtx = document.getElementById('differenceChart').getContext('2d');
                new Chart(diffCtx, {
                    type: 'line',
                    data: {
                        labels: heights,
                        datasets: [{
                            label: 'Разность температур (газ - материал), °C',
                            data: differences,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Разность температур по высоте слоя'
                            }
                        },
                        scales: {
                            y: {
                                title: {
                                    display: true,
                                    text: 'ΔT, °C'
                                },
                                beginAtZero: false
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Высота, м'
                                }
                            }
                        }
                    }
                });
            });
        </script>
    }

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
}